{{- $category := .Title -}}
{{- $entries := where .Site.RegularPages "Params.categories" $category -}}
{{- $uniqueLocations := dict -}}
{{- $locationArray := slice -}}

{{- range $entry := $entries -}}
    {{- $location := $entry.Params.location -}}
    {{- if not (isset $uniqueLocations $location) -}}
        {{- $uniqueLocations = $uniqueLocations | merge (dict $location (dict "value" (len $uniqueLocations) "label" $location "count" 0)) -}}
    {{- end -}}
    {{- $currentLoc := index $uniqueLocations $location -}}
    {{- $currentCount := $currentLoc.count | int -}}
    {{- $uniqueLocations = $uniqueLocations | merge (dict $location (dict "value" $currentLoc.value "label" $location "count" (add $currentCount 1))) -}}
{{- end -}}

{{- range $key, $value := $uniqueLocations -}}
    {{- $locationArray = $locationArray | append $value -}}
{{- end -}}

{
  "category": {{ $category | jsonify }},
  "locations": {{ $uniqueLocations | jsonify }},
  "entries": [
    {{- range $index, $entry := $entries -}}
        {{- if $index }},{{ end -}}
        {
            "address": {{ $entry.Params.address | jsonify }},
            "categories": {{ $entry.Params.categories | jsonify }},
            "company": {{ $entry.Params.company | jsonify }},
            "countries": {{ $entry.Params.countries | jsonify }},
            "credentials": {{ $entry.Params.credentials | jsonify }},
            "description": {{ $entry.Params.description | markdownify | jsonify }},
            "email": {{ $entry.Params.email | jsonify }},
            "email2": {{ $entry.Params.email2 | jsonify }},
            "fax": {{ $entry.Params.fax | jsonify }},
            "fees": {{ $entry.Params.fees | markdownify | jsonify }},
            "first_name": {{ $entry.Params.first_name | jsonify }},
            "id": {{ $entry.Params.id | jsonify }},
            "job_title": {{ $entry.Params.job_title | jsonify }},
            "last_name": {{ $entry.Params.last_name | jsonify }},
            "last_update": {{ $entry.Params.last_update | jsonify }},
            "location": {{ $entry.Params.location | jsonify }},
            "phone": {{ $entry.Params.phone | jsonify }},
            "regions": {{ $entry.Params.regions | jsonify }},
            "salutation": {{ $entry.Params.salutation | jsonify }},
            "short_desc": {{ $entry.Params.short_desc | markdownify | jsonify }},
            "status": {{ $entry.Params.status | jsonify }},
            "title": {{ $entry.Title | jsonify }},
            "website": {{ $entry.Params.website | jsonify }},
            "website2": {{ $entry.Params.website2 | jsonify }}
        }
    {{- end -}}
  ]
}
